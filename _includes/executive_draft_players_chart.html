
<script>
let rawTransactionData = [];
let stackedChart = null;
let currentExecDraftStat = currentStat; // or 'bpm'

d3.csv("https://raw.githubusercontent.com/mcoirad/the-grunfeld/master/_data/drafted_players/{{ include.exec_href }}.csv").then(data => {
  rawTransactionData = data;
  makeStackedChart();
});

function makeStackedChart() {
  const ctx = document.getElementById("executive_draft_players_chart").getContext("2d");
  const { labels, draftData, expectedData, tooltipData } = getStackedChartMappedData(currentExecDraftStat);

  stackedChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: `Expected ${currentExecDraftStat.toUpperCase()}`,
          data: expectedData,
          backgroundColor: 'red',
        },
        {
          label: `Draft ${currentExecDraftStat.toUpperCase()}`,
          data: draftData,
          backgroundColor: 'blue',
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.label} | ${tooltipData[context.dataIndex]}`;
            }
          }
        },
        title: {
          display: true,
          text: 'Drafted Players – Expected vs Actual'
        }
      },
      scales: {
        x: {
          stacked: false  // ← not stacked = grouped bars
        },
        y: {
          stacked: false, // ← disable vertical stacking
          title: {
            display: true,
            text: currentExecDraftStat.toUpperCase()
          }
        }
      }
    }
  });
}

function getStackedChartMappedData(stat) {
  const filtered = rawTransactionData
    .filter(d => d[`draft_${stat}`] !== "" && d[`expected_${stat}`] !== "")
    .map(d => ({
      name: d.name,
      draft: parseFloat(d[`draft_${stat}`]),
      expected: parseFloat(d[`expected_${stat}`]),
      draftPick: d[`draft_pick_${stat}`]
    }))
    .sort((a, b) => b.draft - a.draft);

  const labels = [];
  const draftData = [];
  const expectedData = [];
  const tooltipData = [];

  for (const d of filtered) {
    labels.push(d.name);
    draftData.push(d.draft);
    expectedData.push(d.expected);
    tooltipData.push(`Draft Pick ${d.draftPick}`);
  }

  return { labels, draftData, expectedData, tooltipData };
}

function updateExecDraftPlayersChart() {
  currentExecDraftStat = currentStat;

  const { labels, draftData, expectedData, tooltipData } = getStackedChartMappedData(currentExecDraftStat);
  stackedChart.data.labels = labels;
  stackedChart.data.datasets[0].data = expectedData;
  stackedChart.data.datasets[0].label = `Expected ${currentExecDraftStat.toUpperCase()}`;
  stackedChart.data.datasets[1].data = draftData;
  stackedChart.data.datasets[1].label = `Draft ${currentExecDraftStat.toUpperCase()}`;
  stackedChart.options.scales.y.title.text = currentExecDraftStat.toUpperCase();

  stackedChart.options.plugins.tooltip.callbacks.label = function(context) {
    const index = context.dataIndex;
    return `${tooltipData[index]} | Draft Pick ${rawTransactionData[index]['draft_pick_' + currentExecDraftStat]}`;
  };

  stackedChart.update();
}
</script>
